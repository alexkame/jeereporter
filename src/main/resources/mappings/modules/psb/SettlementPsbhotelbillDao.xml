<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.thinkgem.psb.psbbill.dao.SettlementPsbhotelbillDao">
    
	<sql id="settlementPsbhotelbillColumns">
		a.id AS "id",
		a.psbid AS "psbid",
		a.psbname AS "psbname",
		a.hotelid AS "hotelid",
		a.hotelpms AS "hotelpms",
		a.hotelname AS "hotelname",
		a.procode AS "procode",
		a.proname AS "proname",
		a.citycode AS "citycode",
		a.cityname AS "cityname",
		a.discode AS "discode",
		a.disname AS "disname",
		a.roomnums AS "roomnums",
		a.onlinestate AS "onlinestate",
		a.areamanager AS "areamanager",
		a.operator AS "operator",
		a.begintime AS "begintime",
		a.endtime AS "endtime",
		a.realendtime AS "realendtime",
		a.onlinetime AS "onlinetime",
		a.offlinetime AS "offlinetime",
		a.fee AS "fee",
		a.feetypeids AS "feetypeids",
		a.onlinedays AS "onlinedays",
		a.amount AS "amount",
		a.recoveramount AS "recoveramount",
		a.createtime AS "createtime",
		a.updatetime AS "updatetime",
		a.status AS "status",
		a.billstarttime AS "billstarttime",
		a.billendtime AS "billendtime",
		a.billtype AS "billtype",
		a.billtypedesc AS "billtypedesc"
	</sql>
	
	<sql id="settlementPsbhotelbillJoins">
	</sql>
    
	<select id="get" resultType="SettlementPsbhotelbill">
		SELECT 
			<include refid="settlementPsbhotelbillColumns"/>
		FROM settlement_psbhotelbill a
		<include refid="settlementPsbhotelbillJoins"/>
		WHERE a.id = #{id}
	</select>
	
	<select id="findList" resultType="SettlementPsbhotelbill">
		SELECT 
			<include refid="settlementPsbhotelbillColumns"/>
		FROM settlement_psbhotelbill a
		<include refid="settlementPsbhotelbillJoins"/>
		<where>
			
			<if test="id != null and id != ''">
				AND a.id = #{id}
			</if>
			<if test="psbid != null and psbid != ''">
				AND a.psbid = #{psbid}
			</if>
			<if test="psbname != null and psbname != ''">
				AND a.psbname LIKE 
					<if test="dbName == 'oracle'">'%'||#{psbname}||'%'</if>
					<if test="dbName == 'mssql'">'%'+#{psbname}+'%'</if>
					<if test="dbName == 'mysql'">concat('%',#{psbname},'%')</if>
			</if>
			<if test="hotelid != null and hotelid != ''">
				AND a.hotelid = #{hotelid}
			</if>
			<if test="hotelpms != null and hotelpms != ''">
				AND a.hotelpms = #{hotelpms}
			</if>
			<if test="hotelname != null and hotelname != ''">
				AND a.hotelname LIKE 
					<if test="dbName == 'oracle'">'%'||#{hotelname}||'%'</if>
					<if test="dbName == 'mssql'">'%'+#{hotelname}+'%'</if>
					<if test="dbName == 'mysql'">concat('%',#{hotelname},'%')</if>
			</if>
			<if test="procode != null and procode != ''">
				AND a.procode = #{procode}
			</if>
			<if test="proname != null and proname != ''">
				AND a.proname = #{proname}
			</if>
			<if test="citycode != null and citycode != ''">
				AND a.citycode = #{citycode}
			</if>
			<if test="cityname != null and cityname != ''">
				AND a.cityname = #{cityname}
			</if>
			<if test="discode != null and discode != ''">
				AND a.discode = #{discode}
			</if>
			<if test="disname != null and disname != ''">
				AND a.disname = #{disname}
			</if>
			<if test="beginRoomnums != null and endRoomnums != null and beginRoomnums != '' and endRoomnums != ''">
				AND a.roomnums BETWEEN #{beginRoomnums} AND #{endRoomnums}
			</if>
			<if test="onlinestate != null and onlinestate != ''">
				AND a.onlinestate = #{onlinestate}
			</if>
			<if test="areamanager != null and areamanager != ''">
				AND a.areamanager = #{areamanager}
			</if>
			<if test="operator != null and operator != ''">
				AND a.operator = #{operator}
			</if>
			<if test="beginBegintime != null and beginBegintime != ''">
				AND a.begintime <![CDATA[>=]]> #{beginBegintime}
			</if>
			<if test="endBegintime != null and endBegintime != ''">
				AND a.begintime <![CDATA[<]]> #{endBegintime}
			</if>
			<if test="beginEndtime != null and beginEndtime != ''">
				AND a.endtime <![CDATA[>=]]> #{beginEndtime}
			</if>
			<if test="endEndtime != null and endEndtime != ''">
				AND a.endtime <![CDATA[<]]> #{endEndtime}
			</if>
			<if test="beginRealendtime != null and beginRealendtime != ''">
				AND a.realendtime <![CDATA[>=]]> #{beginRealendtime}
			</if>
			<if test="endRealendtime != null and endRealendtime != ''">
				AND a.realendtime <![CDATA[<]]> #{endRealendtime}
			</if>
			<if test="beginOnlinetime != null and beginOnlinetime != ''">
				AND a.onlinetime <![CDATA[>=]]> #{beginOnlinetime}
			</if>
			<if test="endOnlinetime != null and endOnlinetime != ''">
				AND a.onlinetime <![CDATA[<]]> #{endOnlinetime}
			</if>
			<if test="beginOfflinetime != null and beginOfflinetime != ''">
				AND a.offlinetime <![CDATA[>=]]> #{beginOfflinetime}
			</if>
			<if test="endOfflinetime != null and endOfflinetime != ''">
				AND a.offlinetime <![CDATA[<]]> #{endOfflinetime}
			</if>
			<if test="beginFee != null and endFee != null and beginFee != '' and endFee != ''">
				AND a.fee BETWEEN #{beginFee} AND #{endFee}
			</if>
			<if test="feetypeids != null and feetypeids != ''">
				AND a.feetypeids LIKE 
					<if test="dbName == 'oracle'">'%'||#{feetypeids}||'%'</if>
					<if test="dbName == 'mssql'">'%'+#{feetypeids}+'%'</if>
					<if test="dbName == 'mysql'">concat('%',#{feetypeids},'%')</if>
			</if>
			<if test="beginOnlinedays != null and endOnlinedays != null and beginOnlinedays != '' and endOnlinedays != ''">
				AND a.onlinedays BETWEEN #{beginOnlinedays} AND #{endOnlinedays}
			</if>
			<if test="beginAmount != null and endAmount != null and beginAmount != '' and endAmount != ''">
				AND a.amount BETWEEN #{beginAmount} AND #{endAmount}
			</if>
			<if test="beginRecoveramount != null and endRecoveramount != null and beginRecoveramount != '' and endRecoveramount != ''">
				AND a.recoveramount BETWEEN #{beginRecoveramount} AND #{endRecoveramount}
			</if>
			<if test="beginCreatetime != null and beginCreatetime != ''">
				AND a.createtime <![CDATA[>=]]> #{beginCreatetime}
			</if>
			<if test="endCreatetime != null and endCreatetime != ''">
				AND a.createtime <![CDATA[<]]> #{endCreatetime}
			</if>
			<if test="beginUpdatetime != null and endUpdatetime != null and beginUpdatetime != '' and endUpdatetime != ''">
				AND a.updatetime BETWEEN #{beginUpdatetime} AND #{endUpdatetime}
			</if>
			<if test="status != null and status != ''">
				AND a.status = #{status}
			</if>
			<if test="beginBillstarttime != null and beginBillstarttime != ''">
				AND a.billstarttime <![CDATA[>=]]> #{beginBillstarttime}
			</if>
			<if test="endBillstarttime != null and endBillstarttime != ''">
				AND a.billstarttime <![CDATA[<]]> #{endBillstarttime}
			</if>
			<if test="beginBillendtime != null and beginBillendtime != ''">
				AND a.billendtime <![CDATA[>=]]> #{beginBillendtime}
			</if>
			<if test="endBillendtime != null and endBillendtime != ''">
				AND a.billendtime <![CDATA[<]]> #{endBillendtime}
			</if>
			<if test="billtype != null and billtype != ''">
				AND a.billtype = #{billtype }
			</if>
		</where>
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
			</otherwise>
		</choose>
	</select>
	
	<select id="findAllList" resultType="SettlementPsbhotelbill">
		SELECT 
			<include refid="settlementPsbhotelbillColumns"/>
		FROM settlement_psbhotelbill a
		<include refid="settlementPsbhotelbillJoins"/>
		<where>
			
		</where>		
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
			</otherwise>
		</choose>
	</select>
	
	<!-- 根据酒店id 去重 开始时间-结束时间 未结算 -->
	<select id="getPeriodBillByhotelid" parameterType="SettlementPsbhotelbill" resultType="SettlementPsbhotelbill">
		SELECT 
			<include refid="settlementPsbhotelbillColumns"/>
		FROM settlement_psbhotelbill a
		<include refid="settlementPsbhotelbillJoins"/>
		<where>
			a.hotelid = #{hotelid }
			AND a.billendtime <![CDATA[>]]> #{billstarttime }
			AND a.status = 1
		</where>
	</select>
	
	<insert id="insert">
		INSERT INTO settlement_psbhotelbill(
			psbid,
			psbname,
			hotelid,
			hotelpms,
			hotelname,
			procode,
			proname,
			citycode,
			cityname,
			discode,
			disname,
			roomnums,
			onlinestate,
			areamanager,
			operator,
			begintime,
			endtime,
			realendtime,
			onlinetime,
			offlinetime,
			fee,
			feetypeids,
			onlinedays,
			amount,
			recoveramount,
			createtime,
			updatetime,
			status,
			billstarttime,
			billendtime
		) VALUES (
			#{psbid},
			#{psbname},
			#{hotelid},
			#{hotelpms},
			#{hotelname},
			#{procode},
			#{proname},
			#{citycode},
			#{cityname},
			#{discode},
			#{disname},
			#{roomnums},
			#{onlinestate},
			#{areamanager},
			#{operator},
			#{begintime},
			#{endtime},
			#{realendtime},
			#{onlinetime},
			#{offlinetime},
			#{fee},
			#{feetypeids},
			#{onlinedays},
			#{amount},
			#{recoveramount},
			#{createtime},
			#{updatetime},
			#{status},
			#{billstarttime},
			#{billendtime}
		)
	</insert>
	
	<!-- 批量插入到账单初始化表中 返回 插入记录条数 -->
	<insert id="batchInsert">
		INSERT INTO settlement_psbhotelbill (
			psbid,
			psbname,
			hotelid,
			hotelpms,
			hotelname,
			procode,
			proname,
			citycode,
			cityname,
			discode,
			disname,
			roomnums,
			onlinestate,
			areamanager,
			operator,
			begintime,
			endtime,
			realendtime,
			onlinetime,
			offlinetime,
			fee,
			feetypeids,
			onlinedays,
			amount,
			recoveramount,
			createtime,
			updatetime,
			status,
			billtype,
			billtypedesc,
			billstarttime,
			billendtime
		)
		VALUES <foreach collection="hotelbillList" item="item" index="index" separator=",">
		( 	#{item.psbid},
			#{item.psbname},
			#{item.hotelid},
			#{item.hotelpms},
			#{item.hotelname},
			#{item.procode},
			#{item.proname},
			#{item.citycode},
			#{item.cityname},
			#{item.discode},
			#{item.disname},
			#{item.roomnums},
			#{item.onlinestate},
			#{item.areamanager},
			#{item.operator},
			#{item.begintime},
			#{item.endtime},
			#{item.realendtime},
			#{item.onlinetime},
			#{item.offlinetime},
			#{item.fee},
			#{item.feetypeids},
			#{item.onlinedays},
			#{item.amount},
			#{item.recoveramount},
			#{item.createtime},
			#{item.updatetime},
			#{item.status},
			#{item.billtype},
			#{item.billtypedesc},
			#{item.billstarttime},
			#{item.billendtime}
		)
		</foreach>
	</insert>
	
	<update id="update">
		UPDATE settlement_psbhotelbill SET 	
			psbid = #{psbid},
			psbname = #{psbname},
			hotelid = #{hotelid},
			hotelpms = #{hotelpms},
			hotelname = #{hotelname},
			procode = #{procode},
			proname = #{proname},
			citycode = #{citycode},
			cityname = #{cityname},
			discode = #{discode},
			disname = #{disname},
			roomnums = #{roomnums},
			onlinestate = #{onlinestate},
			areamanager = #{areamanager},
			operator = #{operator},
			begintime = #{begintime},
			endtime = #{endtime},
			realendtime = #{realendtime},
			onlinetime = #{onlinetime},
			offlinetime = #{offlinetime},
			fee = #{fee},
			feetypeids = #{feetypeids},
			onlinedays = #{onlinedays},
			amount = #{amount},
			recoveramount = #{recoveramount},
			createtime = #{createtime},
			updatetime = #{updatetime},
			status = #{status},
			billstarttime = #{billstarttime},
			billendtime = #{billendtime}
		WHERE id = #{id}
	</update>
	
	<update id="delete">
		DELETE FROM settlement_psbhotelbill
		WHERE id = #{id}
	</update>
	
	<!-- 批量 修改账单状态为: 已结算 -->
	<update id="settlebill">
		UPDATE settlement_psbhotelbill a SET a.status = 2
		WHERE a.id IN
			<foreach collection="ids" item="item" index="index" open="(" separator="," close=")">
				#{item}
		  	</foreach> 	
	</update>
	
	<!-- 批量 修改账单状态为: 本期不结算 -->
	<update id="nobill">
		UPDATE settlement_psbhotelbill a SET a.status = 3
		WHERE a.id IN
			<foreach collection="ids" item="item" index="index" open="(" separator="," close=")">
				#{item}
		  	</foreach> 	
	</update>
	
</mapper>