<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.thinkgem.crm.user.dao.RfCrmUserDevicDao">
    
	<sql id="rfCrmUserDevicColumns">
		a.id AS "id",
		a.user_id AS "userId",
		a.login_name AS "loginName",
		a.channel_id AS "channelId",
		a.login_devic AS "loginDevic",
		a.devic_info AS "devicInfo",
		a.create_time AS "createTime",
		a.update_time AS "updateTime",
		a.remarks AS "remarks",
		a.sys_type AS "sysType"
	</sql>

	<sql id="rfOmsUserLoginColumns">
		a.login_name AS "loginName",
		a.firstTime AS "firstTime",
		a.lastTime AS "lastTime",
		d.hotelName AS "hotelName",
		d.id AS "hotelId",
		e.ProName AS "provName",
		cc.CityName AS "cityName",
		td.DisName AS "disName",
		crmh.distribut_cooperate AS "distributCooperate",
		crmh.wash_cooperate AS "washCooperate",
		crmh.supply_cooperate AS "supplyCooperate",
		sru.USER_NAME AS "salerName",
		sru.USER_MOBILE AS "salerMobile"
	</sql>
	
	<sql id="rfCrmUserDevicJoins">
	</sql>

	<sql id="rfOmsUserLoginJoins">
		INNER JOIN ots.h_user b ON a.login_name = b.loginname
		INNER JOIN ots.h_group_hotel c ON b.groupid = c.groupid
		INNER JOIN ots.e_hotel d ON c.hotelid = d.id
		LEFT JOIN ots.t_province e ON e.`Code` = d.provcode
		LEFT JOIN ots.t_city cc ON cc.`Code` = d.citycode
		LEFT JOIN ots.t_district td ON td.`Code` = d.discode
		LEFT JOIN ots.rf_crm_hotel crmh ON crmh.id = d.id
		LEFT JOIN ots.rf_crm_hotel_public hp ON hp.hotel_id = d.id
		LEFT JOIN ots.sy_org_user sru ON sru.USER_CODE = hp.hotel_user_id
	</sql>
    
	<select id="get" resultType="RfCrmUserDevic">
		SELECT 
			<include refid="rfCrmUserDevicColumns"/>
		FROM rf_crm_user_devic a
		<include refid="rfCrmUserDevicJoins"/>
		WHERE a.id = #{id}
	</select>
	
	<select id="findList" resultType="RfCrmUserDevic">
		SELECT 
			<include refid="rfCrmUserDevicColumns"/>
		FROM rf_crm_user_devic a
		<include refid="rfCrmUserDevicJoins"/>
		<where>
			
			<if test="id != null and id != ''">
				AND a.id = #{id}
			</if>
			<if test="userId != null and userId != ''">
				AND a.user_id = #{userId}
			</if>
			<if test="loginName != null and loginName != ''">
				AND a.login_name = #{loginName}
			</if>
			<if test="channelId != null and channelId != ''">
				AND a.channel_id = #{channelId}
			</if>
			<if test="loginDevic != null and loginDevic != ''">
				AND a.login_devic = #{loginDevic}
			</if>
			<if test="devicInfo != null and devicInfo != ''">
				AND a.devic_info = #{devicInfo}
			</if>
			<if test="createTime != null and createTime != ''">
				AND a.create_time = #{createTime}
			</if>
			<if test="updateTime != null and updateTime != ''">
				AND a.update_time = #{updateTime}
			</if>
			<if test="remarks != null and remarks != ''">
				AND a.remarks = #{remarks}
			</if>
			<if test="sysType != null and sysType != ''">
				AND a.sys_type = #{sysType}
			</if>
		</where>
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
			</otherwise>
		</choose>
	</select>
	
	<select id="findAllList" resultType="RfCrmUserDevic">
		SELECT 
			<include refid="rfCrmUserDevicColumns"/>
		FROM rf_crm_user_devic a
		<include refid="rfCrmUserDevicJoins"/>
		<where>
			
		</where>		
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
			</otherwise>
		</choose>
	</select>

	<select id="findOmsLoginList" resultType="RfCrmUserDevic">
		SELECT
		<include refid="rfOmsUserLoginColumns"/>
		FROM 	(
			SELECT
				a.login_name,
				min(a.create_time) firstTime,
				max(a.create_time) lastTime,
				max(a.devic_info) devic_info,
				max(a.login_devic) login_devic,
				a.sys_type,
				b.source
			FROM
				`rf_crm_user_devic` a
			LEFT JOIN auth.auth_user b ON a.login_name = b.username
			WHERE
				b.username NOT IN (
				'18801284631',
				'13716075851',
				'11111111111'
				)
			GROUP BY
			a.login_name
		) as a
		<include refid="rfOmsUserLoginJoins"/>
		<where>
			a.sys_type = 2 and (a.source = 'HMS' or a.source = 'CRM')
			<if test="hotelName != null and hotelName != ''">
				AND d.hotelName like CONCAT('%', #{hotelName}, '%')
			</if>
		</where>
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
			</otherwise>
		</choose>
	</select>
	
	<insert id="insert">
		INSERT INTO rf_crm_user_devic(
			id,
			user_id,
			login_name,
			channel_id,
			login_devic,
			devic_info,
			create_time,
			update_time,
			remarks,
			sys_type
		) VALUES (
			#{id},
			#{userId},
			#{loginName},
			#{channelId},
			#{loginDevic},
			#{devicInfo},
			#{createTime},
			#{updateTime},
			#{remarks},
			#{sysType}
		)
	</insert>
	
	<update id="update">
		UPDATE rf_crm_user_devic SET 	
			user_id = #{userId},
			login_name = #{loginName},
			channel_id = #{channelId},
			login_devic = #{loginDevic},
			devic_info = #{devicInfo},
			create_time = #{createTime},
			update_time = #{updateTime},
			remarks = #{remarks},
			sys_type = #{sysType}
		WHERE id = #{id}
	</update>
	
	<update id="delete">
		DELETE FROM rf_crm_user_devic
		WHERE id = #{id}
	</update>
	
</mapper>