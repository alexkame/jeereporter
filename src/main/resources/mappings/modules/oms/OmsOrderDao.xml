<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.thinkgem.jeesite.modules.oms.dao.OmsOrderDao">
    
	<sql id="omsOrderColumns">
		a.id AS orderId,
		a.s_atime AS sAtime,
		a.s_mtime AS sMtime,
		a.s_cmpy AS sCmpy,
		a.status AS status,
		a.yz_orderid AS yzOrderid,
		a.userid AS userid,
		a.trade_memo AS "tradeMemo",
		a.receiver_city AS "receiverCity",
		a.receiver_district AS "receiverDistrict",
		a.receiver_state AS "receiverState",
		a.receiver_address AS "receiverAddress",
		a.receiver_zip AS "receiverZip",
		a.receiver_mobile AS "receiverMobile",
		a.post_fee AS "postFee",
		a.totole_fee AS "totoleFee",
		a.refunded_fee AS "refundedFee",
		a.discount AS "discount",
		a.payment AS "payment",
		a.title AS "title",
		a.marketid AS "marketid",
		a.pay_status AS "payStatus",
		a.pay_memo AS "payMemo",
		a.receiver_name AS "receiverName",
		a.market_name AS "marketName",
		a.market_moble AS "marketMoble",
		a.buyer_message AS "buyerMessage",
	
		a.buyer_nick AS "buyerNick",
		a.consign_time AS "consignTime",
		a.sign_time AS "signTime",
		a.remarks AS "remarks",
		a.yun_dan_self AS "yunDanSelf",
		a.exp_batch AS "expBatch",
		a.invoice_time AS "invoiceTime",
		a.receipt_id as "receiptid"
	</sql>
	
	<sql id="omsOrderJoins">
        LEFT JOIN wc_user_hotel h ON h.HOTELID = a.S_CMPY
	</sql>

    <sql id="omsOrderJoins1">
        LEFT JOIN wc_user_hotel h ON h.HOTELID = a.S_CMPY
        RIGHT JOIN oms_order_item i ON i.ORDERID = a.ID
		LEFT JOIN oms_commodity c ON c.num_iid = i.SKUID
		LEFT JOIN oms_commodity_column cc ON cc.promotion_cid = c.tag_ids
    </sql>
    
	<select id="get" resultType="OmsOrder">
		SELECT 
			<include refid="omsOrderColumns"/>
            ,
           
			m.name as "shopName",
			u.userid as "hmsuserid",
			u.userName AS "userName",
			h.hmsid  AS "hmsid",
			h.hotelName AS "hotelName",
			r.RTYPE_NAME as "receiptTypeName",
			r.RECEIPT_CODE as "receiptCode",
			r.RECEIPT_DATE as "receiptDate"					
		 from oms_order a LEFT JOIN wc_user u on a.USERID=u.ID
		LEFT JOIN wc_user_hotel h on h.USERID=a.USERID and  h.HOTELID=a.S_CMPY
		LEFT JOIN oms_market_info m on a.shopid=m.id
		LEFT JOIN oms_receipt r on a.receipt_id = r.id
		WHERE a.id = #{orderId}
	</select>
	
	<select id="findReport" resultType="OmsOrderReport">
	SELECT 
			<include refid="omsOrderColumns"/>
            ,
			m.name as "shopName",
			u.userid as "hmsuserid",
			u.userName AS "userName",
			h.hmsid  AS "hmsid",
			h.hotelName AS "hotelName"
			,
			i.num  "num" ,
			i.TOTOLE_FEE "comtotoleFee", 
			c.outer_id "sku",
			t.`name` "comType",
			i.TITLE "comName"
		 from oms_order a LEFT JOIN wc_user u on a.USERID=u.ID
		LEFT JOIN wc_user_hotel h on h.USERID=a.USERID and  h.HOTELID=a.S_CMPY
		LEFT JOIN oms_market_info m on a.shopid=m.id
		LEFT JOIN oms_order_item i on a.id=i.ORDERID
		LEFT JOIN oms_commodity c on i.SKUID=c.num_iid and a.shopid=c.shopid
		LEFT JOIN oms_commodity_column t on c.tag_ids=t.promotion_cid and c.shopid=t.shopid 
		<where>
		<if test="searchId!= null and searchId !='' ">
				AND a.id = #{searchId}
			</if>
			<if test="yzOrderid != null and yzOrderid != '' ">
				AND a.yz_orderid = #{yzOrderid}
			</if>
			
			<if test="startTime != null and startTime != ''">
				AND a.s_atime &gt;= #{startTimeStr}
			</if>
            <if test="endTime != null and endTime != ''">
                AND a.s_atime &lt;= #{endTimeStr}
            </if>
             <if test="startUpdateTime != null and startUpdateTime != ''">
				AND a.s_mtime &gt;= #{startUpdateTime}
			</if>
            <if test="endUpdateTime != null and endUpdateTime != ''">
                AND a.s_mtime &lt;= #{endUpdateTime}
            </if>
            
            <if test="startPayTimeStr != null and startPayTimeStr != ''">
				AND a.PAY_MEMO &gt;= #{startPayTimeStr}
			</if>
            <if test="endPayTimeStr != null and endPayTimeStr != ''">
                AND a.PAY_MEMO &lt;= #{endPayTimeStr}
            </if>
            
            <if test="startInvoiceTime != null and startInvoiceTime != ''">
				AND (a.INVOICE_TIME &gt;= #{startInvoiceTime} or a.INVOICE_TIME= '')
			</if>
            <if test="endInvoiceTime != null and endInvoiceTime != ''">
                AND (a.INVOICE_TIME &lt;= #{endInvoiceTime} or a.INVOICE_TIME= '')
            </if>
            
            <if test="startConsignTime != null and startConsignTime != ''">
				AND a.CONSIGN_TIME &gt;= #{startConsignTime}
			</if>
            <if test="endConsignTime != null and endConsignTime != ''">
                AND a.CONSIGN_TIME &lt;= #{endConsignTime}
            </if>                         
            
            <if test="statusIn != null ">
				AND a.status in
				 <foreach collection="statusIn" item="sta" index="index"
            open="(" close=")" separator=",">
            #{sta}
        	</foreach>
			
			</if>
			
			
			
			
			<if test="shopid != null">
				AND a.shopid = #{shopid}
			</if>
			<if test="title != null and title != ''">
				AND a.title LIKE 
					<if test="dbName == 'oracle'">'%'||#{title}||'%'</if>
					<if test="dbName == 'mssql'">'%'+#{title}+'%'</if>
					<if test="dbName == 'mysql'">concat('%',#{title},'%')</if>
			</if>
			<if test="marketName != null and marketName != ''">
				AND a.market_name LIKE
					<if test="dbName == 'oracle'">'%'||#{marketName}||'%'</if>
					<if test="dbName == 'mssql'">'%'+#{marketName}+'%'</if>
					<if test="dbName == 'mysql'">concat('%',#{marketName},'%')</if>
			</if>
			<if test="payStatus != null and payStatus != ''">
				AND a.pay_status = #{payStatus}
			</if>
			<if test="receiverState != null and receiverState != ''">
				AND a.receiver_state LIKE concat('%',#{receiverState},'%')
			</if>
			<if test="receiverCity != null and receiverCity != ''">
				AND a.receiver_city LIKE concat('%',#{receiverCity},'%')
			</if>
			<if test="receiverDistrict != null and receiverDistrict != ''">
				AND a.receiver_district LIKE concat('%',#{receiverDistrict},'%')
			</if>
			<if test="receiverAddress != null and receiverAddress != ''">
				AND a.receiver_address LIKE concat('%',#{receiverAddress},'%')
			</if>
			<if test="hmsid != null and hmsid != ''">
				AND h.hmsid = #{hmsid}
			</if>
			<if test="hotelName != null and hotelName != ''">
				AND h.hotelName LIKE concat('%',#{hotelName},'%')
			</if>
			
			<if test="hmsuserid != null and hmsuserid != ''">
				AND u.userid = #{hmsuserid}
			</if>
			
			
			<if test="hmsid != null and hmsid != ''">
				AND h.hmsid = #{hmsid}
			</if>
			<if test="comType != null and comType != ''">
				AND t.name   LIKE concat('%',#{comType},'%')
			</if>
			
            
            
		</where>
        ORDER BY a.s_atime desc, a.id desc,i.id desc
	
	
	</select>
	
	
	<select id="findList" resultType="OmsOrder">
		SELECT 
			<include refid="omsOrderColumns"/>
            ,
			m.name as "shopName",
			u.userid as "hmsuserid",
			u.userName AS "userName",
			h.hmsid  AS "hmsid",
			h.hotelName AS "hotelName",
			r.RTYPE_NAME as "receiptTypeName",
			r.RECEIPT_CODE as "receiptCode",
			r.RECEIPT_DATE as "receiptDate"
		 from oms_order a LEFT JOIN wc_user u on a.USERID=u.ID
		LEFT JOIN wc_user_hotel h on h.USERID=a.USERID and  h.HOTELID=a.S_CMPY
		LEFT JOIN oms_market_info m on a.shopid=m.id
		LEFT JOIN oms_receipt r on a.receipt_id = r.id
		<where>
		    <if test="searchId != null and searchId !='' ">
				AND a.id = #{searchId}
			</if>
			<if test="yzOrderid != null and yzOrderid != '' ">
				AND a.yz_orderid = #{yzOrderid}
			</if>
			
			<if test="startTime != null and startTime != ''">
				AND a.s_atime &gt;= #{startTimeStr}
			</if>
            <if test="endTime != null and endTime != ''">
                AND a.s_atime &lt;= #{endTimeStr}
            </if>
            
            <if test="startUpdateTime != null and startUpdateTime != ''">
				AND a.s_mtime &gt;= #{startUpdateTime}
			</if>
            <if test="endUpdateTime != null and endUpdateTime != ''">
                AND a.s_mtime &lt;= #{endUpdateTime}
            </if>

            <if test="startConsignTime != null and startConsignTime != ''">
				AND a.CONSIGN_TIME &gt;= #{startConsignTime}
			</if>
            <if test="endConsignTime != null and endConsignTime != ''">
                AND a.CONSIGN_TIME &lt;= #{endConsignTime}
            </if>
            
            <if test="startInvoiceTime != null and startInvoiceTime != ''">
				AND a.INVOICE_TIME &gt;= #{startInvoiceTime}
			</if>
            <if test="endInvoiceTime != null and endInvoiceTime != ''">
                AND a.INVOICE_TIME &lt;= #{endInvoiceTime}
            </if>
            
            <if test="startPayTimeStr != null and startPayTimeStr != ''">
				AND a.PAY_MEMO &gt;= #{startPayTimeStr}
			</if>
            <if test="endPayTimeStr != null and endPayTimeStr != ''">
                AND a.PAY_MEMO &lt;= #{endPayTimeStr}
            </if>
            <if test="status != null and status != ''">
				AND a.status = #{status}
			</if>
			<if test="shopid != null">
				AND a.shopid = #{shopid}
			</if>
			
			<if test="title != null and title != ''">
				AND a.title LIKE 
					<if test="dbName == 'oracle'">'%'||#{title}||'%'</if>
					<if test="dbName == 'mssql'">'%'+#{title}+'%'</if>
					<if test="dbName == 'mysql'">concat('%',#{title},'%')</if>
			</if>
			<if test="marketName != null and marketName != ''">
				AND a.market_name LIKE
					<if test="dbName == 'oracle'">'%'||#{marketName}||'%'</if>
					<if test="dbName == 'mssql'">'%'+#{marketName}+'%'</if>
					<if test="dbName == 'mysql'">concat('%',#{marketName},'%')</if>
			</if>
			<if test="payStatus != null and payStatus != ''">
				AND a.pay_status = #{payStatus}
			</if>
			<if test="receiverState != null and receiverState != ''">
				AND a.receiver_state LIKE concat('%',#{receiverState},'%')
			</if>
			<if test="receiverCity != null and receiverCity != ''">
				AND a.receiver_city LIKE concat('%',#{receiverCity},'%')
			</if>
			<if test="receiverDistrict != null and receiverDistrict != ''">
				AND a.receiver_district LIKE concat('%',#{receiverDistrict},'%')
			</if>
			<if test="receiverAddress != null and receiverAddress != ''">
				AND a.receiver_address LIKE concat('%',#{receiverAddress},'%')
			</if>
			<if test="hmsid != null and hmsid != ''">
				AND h.hmsid = #{hmsid}
			</if>
			<if test="hotelName != null and hotelName != ''">
				AND h.hotelName LIKE concat('%',#{hotelName},'%')
			</if>
			
			<if test="hmsuserid != null and hmsuserid != ''">
				AND u.userid = #{hmsuserid}
			</if>
			
			
			<if test="hmsid != null and hmsid != ''">
				AND h.hmsid = #{hmsid}
			</if>
			
            
            
		</where>
        ORDER BY a.s_atime desc
	</select>
	
	<select id="findAllList" resultType="OmsOrder">
		SELECT 
			<include refid="omsOrderColumns"/>
		FROM oms_order a
		<include refid="omsOrderJoins"/>
		<where>
			
		</where>		
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
			</otherwise>
		</choose>
	</select>
	
	<insert id="insert">
		INSERT INTO oms_order(
			id,
			s_atime,
			s_mtime,
			s_cmpy,
			status,
			yz_orderid,
			userid,
			trade_memo,
			receiver_city,
			receiver_district,
			receiver_state,
			receiver_address,
			receiver_zip,
			receiver_mobile,
			post_fee,
			totole_fee,
			refunded_fee,
			discount,
			payment,
			title,
			marketid,
			pay_status,
			pay_memo
		) VALUES (
			#{orderId},
			#{sAtime},
			#{sMtime},
			#{sCmpy},
			#{status},
			#{yzOrderid},
			#{userid},
			#{tradeMemo},
			#{receiverCity},
			#{receiverDistrict},
			#{receiverState},
			#{receiverAddress},
			#{receiverZip},
			#{receiverMobile},
			#{postFee},
			#{totoleFee},
			#{refundedFee},
			#{discount},
			#{payment},
			#{title},
			#{marketid},
			#{payStatus},
			#{payMemo}
		)
	</insert>
	
	<update id="update">
		UPDATE oms_order SET 	
			s_atime = #{sAtime},
			s_mtime = #{sMtime},
			s_cmpy = #{sCmpy},
			status = #{status},
			yz_orderid = #{yzOrderid},
			userid = #{userid},
			trade_memo = #{tradeMemo},
			receiver_city = #{receiverCity},
			receiver_district = #{receiverDistrict},
			receiver_state = #{receiverState},
			receiver_address = #{receiverAddress},
			receiver_zip = #{receiverZip},
			receiver_mobile = #{receiverMobile},
			post_fee = #{postFee},
			totole_fee = #{totoleFee},
			refunded_fee = #{refundedFee},
			discount = #{discount},
			payment = #{payment},
			title = #{title},
			marketid = #{marketid},
			pay_status = #{payStatus},
			pay_memo = #{payMemo}
		WHERE id = #{orderId}
	</update>
	
	<update id="delete">
		DELETE FROM oms_order
		WHERE id = #{orderId}
	</update>
	
	<update id="updateReceiver">
	UPDATE oms_order SET 	
			receiver_city = #{receiverCity},
			receiver_district = #{receiverDistrict},
			receiver_state = #{receiverState},
			receiver_address = #{receiverAddress},
			receiver_zip = #{receiverZip},
			receiver_mobile = #{receiverMobile},
			
			receiver_name = #{receiverName},
			remarks = #{remarks}
		WHERE id = #{orderId} and status=#{status}
	</update>
	
    <select id="findInvoiceOrders" resultType="OmsOrder">
        SELECT 
            <include refid="omsOrderColumns"/>
        FROM oms_order a
          WHERE a.receipt_id = #{invoiceid}
    </select>
	
	<!-- 导出的时候，添加上导出的时间戳 -->
	<update id="updateOrdersExpBatch" >
		update oms_order set exp_batch = #{expBatch} where id in
		<foreach collection="ids" item="id" index="index"
		          open="(" close=")" separator=",">
			#{id}
		</foreach>
	</update>
	

	<select id="findLogisticsReportPage" resultType="OmsOrderLogistic">
		SELECT 
			<include refid="omsOrderColumns"/>
            ,
			m.name as "shopName",
			u.userid as "hmsuserid",
			u.userName AS "userName",
			h.hmsid  AS "hmsid",
			h.hotelName AS "hotelName",
			i.TITLE as "comName",
			i.num as "num",
			i.weight as "weight",
			s.YUNDAN_CODE as "yundanCode",
			s.WULIU_CODE as "wuliuCode",
			s.QIANSHOU_STATUS as "qianShouStatus",
			c.outer_id as "outerId"
		 from oms_order a LEFT JOIN wc_user u on a.USERID = u.ID
		LEFT JOIN wc_user_hotel h on h.USERID=a.USERID and  h.HOTELID=a.S_CMPY
		LEFT JOIN oms_market_info m on a.shopid=m.id
		LEFT JOIN oms_order_item i on a.id=i.ORDERID
		left join oms_commodity c on i.SKUID = c.num_iid and a.shopid = c.shopId
		left join oms_order_item_split s on i.id = s.item_id
		<where>
		<if test="searchId != null and searchId !='' ">
				AND a.id = #{searchId}
			</if>
			<if test="yzOrderid != null and yzOrderid != '' ">
				AND a.yz_orderid = #{yzOrderid}
			</if>
			
			<if test="startTime != null and startTime != ''">
				AND a.s_atime &gt;= #{startTimeStr}
			</if>
            <if test="endTime != null and endTime != ''">
                AND a.s_atime &lt;= #{endTimeStr}
            </if>
            
            <if test="startUpdateTime != null and startUpdateTime != ''">
				AND a.s_mtime &gt;= #{startUpdateTime}
			</if>
            <if test="endUpdateTime != null and endUpdateTime != ''">
                AND a.s_mtime &lt;= #{endUpdateTime}
            </if>

            <if test="startConsignTime != null and startConsignTime != ''">
				AND a.CONSIGN_TIME &gt;= #{startConsignTime}
			</if>
            <if test="endConsignTime != null and endConsignTime != ''">
                AND a.CONSIGN_TIME &lt;= #{endConsignTime}
            </if>
            
            <if test="startInvoiceTime != null and startInvoiceTime != ''">
				AND a.INVOICE_TIME &gt;= #{startInvoiceTime}
			</if>
            <if test="endInvoiceTime != null and endInvoiceTime != ''">
                AND a.INVOICE_TIME &lt;= #{endInvoiceTime}
            </if>
            
            <if test="startPayTimeStr != null and startPayTimeStr != ''">
				AND a.PAY_MEMO &gt;= #{startPayTimeStr}
			</if>
            <if test="endPayTimeStr != null and endPayTimeStr != ''">
                AND a.PAY_MEMO &lt;= #{endPayTimeStr}
            </if>
            <if test="status != null and status != ''">
				AND a.status = #{status}
			</if>
			<if test="shopid != null">
				AND a.shopid = #{shopid}
			</if>
			
			<!-- 物流导出的状态   -->
			<if test="logisticsStatus != null and logisticsStatus == 1">
				AND a.exp_batch is not null AND a.exp_batch != ''
			</if>
			
			<if test="logisticsStatus != null and logisticsStatus == 0">
				AND (a.exp_batch is null or a.exp_batch = '')
			</if>
			
			<if test="expBatchDay != null and expBatchDay != ''">
				AND a.exp_batch like concat('%',#{expBatchDay},'%') 
			</if>
			
			<if test="title != null and title != ''">
				AND a.title LIKE 
					<if test="dbName == 'oracle'">'%'||#{title}||'%'</if>
					<if test="dbName == 'mssql'">'%'+#{title}+'%'</if>
					<if test="dbName == 'mysql'">concat('%',#{title},'%')</if>
			</if>
			<if test="marketName != null and marketName != ''">
				AND a.market_name LIKE
					<if test="dbName == 'oracle'">'%'||#{marketName}||'%'</if>
					<if test="dbName == 'mssql'">'%'+#{marketName}+'%'</if>
					<if test="dbName == 'mysql'">concat('%',#{marketName},'%')</if>
			</if>
			<if test="payStatus != null and payStatus != ''">
				AND a.pay_status = #{payStatus}
			</if>
			<if test="receiverState != null and receiverState != ''">
				AND a.receiver_state LIKE concat('%',#{receiverState},'%')
			</if>
			<if test="receiverCity != null and receiverCity != ''">
				AND a.receiver_city LIKE concat('%',#{receiverCity},'%')
			</if>
			<if test="receiverDistrict != null and receiverDistrict != ''">
				AND a.receiver_district LIKE concat('%',#{receiverDistrict},'%')
			</if>
			<if test="receiverAddress != null and receiverAddress != ''">
				AND a.receiver_address LIKE concat('%',#{receiverAddress},'%')
			</if>
			<if test="hmsid != null and hmsid != ''">
				AND h.hmsid = #{hmsid}
			</if>
			<if test="hotelName != null and hotelName != ''">
				AND h.hotelName LIKE concat('%',#{hotelName},'%')
			</if>
			
			<if test="hmsuserid != null and hmsuserid != ''">
				AND u.userid = #{hmsuserid}
			</if>
			
			
			<if test="hmsid != null and hmsid != ''">
				AND h.hmsid = #{hmsid}
			</if>
		</where>
        ORDER BY a.s_atime desc
	</select>


	<select id="findLogisticsReportExp" resultType="OmsOrderLogisticExp">
		SELECT 
			<include refid="omsOrderColumns"/>
            ,
			m.name as "shopName",
			u.userid as "hmsuserid",
			u.userName AS "userName",
			h.hmsid  AS "hmsid",
			h.hotelName AS "hotelName",
			i.TITLE as "comName",
			i.num as "num",
			i.weight as "weight",
			s.YUNDAN_CODE as "yundanCode",
			s.WULIU_CODE as "wuliuCode",
			s.QIANSHOU_STATUS as "qianShouStatus",					
			c.outer_id as "outerId"
		 from oms_order a LEFT JOIN wc_user u on a.USERID = u.ID
		LEFT JOIN wc_user_hotel h on h.USERID=a.USERID and  h.HOTELID=a.S_CMPY
		LEFT JOIN oms_market_info m on a.shopid=m.id
		LEFT JOIN oms_order_item i on a.id=i.ORDERID
		left join oms_commodity c on i.SKUID = c.num_iid and a.shopid = c.shopId
		left join oms_order_item_split s on i.id = s.item_id
		<where>
		<if test="searchId != null and searchId !='' ">
				AND a.id = #{searchId}
			</if>
			<if test="yzOrderid != null and yzOrderid != '' ">
				AND a.yz_orderid = #{yzOrderid}
			</if>
			
			<if test="startTime != null and startTime != ''">
				AND a.s_atime &gt;= #{startTimeStr}
			</if>
            <if test="endTime != null and endTime != ''">
                AND a.s_atime &lt;= #{endTimeStr}
            </if>
            
            <if test="startUpdateTime != null and startUpdateTime != ''">
				AND a.s_mtime &gt;= #{startUpdateTime}
			</if>
            <if test="endUpdateTime != null and endUpdateTime != ''">
                AND a.s_mtime &lt;= #{endUpdateTime}
            </if>

            <if test="startConsignTime != null and startConsignTime != ''">
				AND a.CONSIGN_TIME &gt;= #{startConsignTime}
			</if>
            <if test="endConsignTime != null and endConsignTime != ''">
                AND a.CONSIGN_TIME &lt;= #{endConsignTime}
            </if>
            
            <if test="startInvoiceTime != null and startInvoiceTime != ''">
				AND a.INVOICE_TIME &gt;= #{startInvoiceTime}
			</if>
            <if test="endInvoiceTime != null and endInvoiceTime != ''">
                AND a.INVOICE_TIME &lt;= #{endInvoiceTime}
            </if>
            
            <if test="startPayTimeStr != null and startPayTimeStr != ''">
				AND a.PAY_MEMO &gt;= #{startPayTimeStr}
			</if>
            <if test="endPayTimeStr != null and endPayTimeStr != ''">
                AND a.PAY_MEMO &lt;= #{endPayTimeStr}
            </if>
            <if test="status != null and status != ''">
				AND a.status = #{status}
			</if>
			<if test="shopid != null">
				AND a.shopid = #{shopid}
			</if>
			
			<!-- 物流导出的状态   -->
			<if test="logisticsStatus != null and logisticsStatus == 1">
				AND a.exp_batch is not null AND a.exp_batch != ''
			</if>
			
			<if test="logisticsStatus != null and logisticsStatus == 0">
				AND (a.exp_batch is null or a.exp_batch = '')
			</if>
			
			<if test="expBatchDay != null and expBatchDay != ''">
				AND a.exp_batch like concat('%',#{expBatchDay},'%') 
			</if>
			
			<if test="title != null and title != ''">
				AND a.title LIKE 
					<if test="dbName == 'oracle'">'%'||#{title}||'%'</if>
					<if test="dbName == 'mssql'">'%'+#{title}+'%'</if>
					<if test="dbName == 'mysql'">concat('%',#{title},'%')</if>
			</if>
			<if test="marketName != null and marketName != ''">
				AND a.market_name LIKE
					<if test="dbName == 'oracle'">'%'||#{marketName}||'%'</if>
					<if test="dbName == 'mssql'">'%'+#{marketName}+'%'</if>
					<if test="dbName == 'mysql'">concat('%',#{marketName},'%')</if>
			</if>
			<if test="payStatus != null and payStatus != ''">
				AND a.pay_status = #{payStatus}
			</if>
			<if test="receiverState != null and receiverState != ''">
				AND a.receiver_state LIKE concat('%',#{receiverState},'%')
			</if>
			<if test="receiverCity != null and receiverCity != ''">
				AND a.receiver_city LIKE concat('%',#{receiverCity},'%')
			</if>
			<if test="receiverDistrict != null and receiverDistrict != ''">
				AND a.receiver_district LIKE concat('%',#{receiverDistrict},'%')
			</if>
			<if test="receiverAddress != null and receiverAddress != ''">
				AND a.receiver_address LIKE concat('%',#{receiverAddress},'%')
			</if>
			<if test="hmsid != null and hmsid != ''">
				AND h.hmsid = #{hmsid}
			</if>
			<if test="hotelName != null and hotelName != ''">
				AND h.hotelName LIKE concat('%',#{hotelName},'%')
			</if>
			
			<if test="hmsuserid != null and hmsuserid != ''">
				AND u.userid = #{hmsuserid}
			</if>
			
			
			<if test="hmsid != null and hmsid != ''">
				AND h.hmsid = #{hmsid}
			</if>
		</where>
        ORDER BY a.s_atime desc
	</select>

	
	<!-- 查询的是给定时间之前的所有的已经支付成功， 并且没有导出过的 -->
	<select id="findLogisticsReport" resultType="OmsOrderLogistic">
	SELECT 
			<include refid="omsOrderColumns"/>
            ,
			m.name as "shopName",
			u.userid as "hmsuserid",
			u.userName AS "userName",
			h.hmsid  AS "hmsid",
			h.hotelName AS "hotelName",
			i.num AS "num" ,
			i.TOTOLE_FEE AS "comtotoleFee", 
			c.outer_id AS "outerId",
			t.`name` AS "comType",
			i.TITLE AS "comName", 
			i.ID as "itemId", 
			i.weight as "weight"
		 from oms_order a LEFT JOIN wc_user u on a.USERID=u.ID
		LEFT JOIN wc_user_hotel h on h.USERID=a.USERID and  h.HOTELID=a.S_CMPY
		LEFT JOIN oms_market_info m on a.shopid=m.id
		LEFT JOIN oms_order_item i on a.id=i.ORDERID
		LEFT JOIN oms_commodity c on i.SKUID=c.num_iid and a.shopid=c.shopid
		LEFT JOIN oms_commodity_column t on c.tag_ids=t.promotion_cid and c.shopid=t.shopid 
		<where>
			<!-- 状态是等待发货 -->
			AND a.status = 'WAIT_SELLER_SEND_GOODS' 

			<!-- 支付状态已支付 -->
			AND a.PAY_STATUS = '1'
			
			<!-- 还没有导出过 -->
			AND (a.exp_batch = '' or  a.exp_batch is null ) 
			
			<!-- 预发货时间  小于 等于参数 -->
 			<if test="invoiceTime != null and invoiceTime != ''">
				AND ( a.INVOICE_TIME &lt;= #{invoiceTime} or a.invoice_time = '' or a.invoice_time is null ) 
			</if>
			
		</where>
        ORDER BY a.id asc, i.id desc
	</select>	
	
	<update id="updateForImp">
		UPDATE oms_order SET 
			qianshou_status = #{qianShouStatus}
		WHERE id = #{orderId} and YZ_ORDERID = #{yzOrderid}
	</update>	
	
</mapper>